name: Update Image Manifest

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ìë™ ì‹¤í–‰ (í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì˜¤í›„ 6ì‹œ)
    - cron: '0 9 * * *'
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install cloudinary
      
    - name: Generate manifest
      run: |
        cat > generate-manifest.js << 'EOF'
        const cloudinary = require('cloudinary').v2;
        const fs = require('fs');

        // Cloudinary ì„¤ì •
        cloudinary.config({
          cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
          api_key: process.env.CLOUDINARY_API_KEY,
          api_secret: process.env.CLOUDINARY_API_SECRET
        });

        const folders = ['BO_SO', 'Breast', 'Endo', 'GI', 'GU_prostate', 'GU_RCC', 'GU_UCC'];

        async function getImagesFromFolder(folder) {
          try {
            console.log(`ğŸ” ${folder} í´ë”ì—ì„œ ì´ë¯¸ì§€ ê²€ìƒ‰ ì¤‘...`);
            
            const result = await cloudinary.api.resources({
              type: 'upload',
              prefix: folder,
              max_results: 500,
              resource_type: 'image'
            });
            
            const images = result.resources.map(resource => {
              // public_idì—ì„œ í™•ì¥ì ì œê±° (íŒŒì¼ëª…ë§Œ)
              return resource.public_id;
            });
            
            console.log(`âœ… ${folder}: ${images.length}ê°œ ì´ë¯¸ì§€ ë°œê²¬`);
            return images;
            
          } catch (error) {
            console.error(`âŒ ${folder} í´ë” ì˜¤ë¥˜:`, error.message);
            return [];
          }
        }

        async function generateManifest() {
          const manifest = {};
          
          for (const folder of folders) {
            manifest[folder] = await getImagesFromFolder(folder);
          }
          
          // manifest.json íŒŒì¼ ìƒì„±
          fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
          console.log('ğŸ“ manifest.json íŒŒì¼ ìƒì„± ì™„ë£Œ');
          console.log('ì´ ì´ë¯¸ì§€ ìˆ˜:', Object.values(manifest).flat().length);
        }

        generateManifest().catch(console.error);
        EOF
        
        node generate-manifest.js
      env:
        CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
        CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
        CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f manifest.json ]; then
          git add manifest.json
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "ğŸ“± ì´ë¯¸ì§€ ëª©ë¡ ìë™ ì—…ë°ì´íŠ¸ $(date '+%Y-%m-%d %H:%M')"
            git push origin main
            echo "âœ… manifest.json ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          fi
        else
          echo "âŒ manifest.json íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
