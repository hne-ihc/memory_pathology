<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Pathology Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 10px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: 80vh;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .previous-answer {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .main-menu {
            padding: 40px 20px;
            text-align: center;
        }
        
        .menu-button {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .quiz-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .quiz-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .o-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .o-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17, 153, 142, 0.3);
        }
        
        .x-button {
            background: linear-gradient(135deg, #ee5a24 0%, #fd79a8 100%);
            color: white;
        }
        
        .x-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(238, 90, 36, 0.3);
        }
        
        .folder-selection {
            padding: 20px;
        }
        
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .folder-btn {
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }
        
        .folder-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .folder-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .quiz-screen {
            padding: 20px;
            text-align: center;
        }
        
        .image-container {
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .quiz-image {
            width: 100%;
            height: auto;
            aspect-ratio: 4/6;
            object-fit: cover;
            display: block;
        }
        
        .image-info {
            background: #f8f9ff;
            padding: 15px;
            border-top: 3px solid #667eea;
        }
        
        .image-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .answer-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
        }
        
        .answer-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .answer-btn.o {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .answer-btn.x {
            background: linear-gradient(135deg, #ee5a24 0%, #fd79a8 100%);
            color: white;
        }
        
        .answer-btn:hover {
            transform: translateY(-2px);
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .control-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .hidden {
            display: none;
        }
        
        .back-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .stats {
            background: #f8f9ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        
        .stat-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Menu -->
        <div id="mainMenu" class="screen">
            <div class="header">
                <h1>Memory Pathology</h1>
            </div>
            <div class="main-menu">
                <button class="menu-button quiz-button" onclick="showFolderSelection('quiz')">QUIZ</button>
                <button class="menu-button o-button" onclick="showFolderSelection('o')">O Collection</button>
                <button class="menu-button x-button" onclick="showFolderSelection('x')">X Collection</button>
                <div class="stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalImages">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="oCount">0</div>
                            <div class="stat-label">O Marked</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="xCount">0</div>
                            <div class="stat-label">X Marked</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Folder Selection -->
        <div id="folderSelection" class="screen hidden">
            <div class="header">
                <button class="back-btn" onclick="showMainMenu()">←</button>
                <h1>Select Folder</h1>
            </div>
            <div class="folder-selection">
                <button class="menu-button quiz-button" onclick="startMode('all')">ALL FOLDERS</button>
                <div class="folder-grid">
                    <button class="folder-btn" onclick="startMode('BO_SO')">BO_SO</button>
                    <button class="folder-btn" onclick="startMode('Breast')">Breast</button>
                    <button class="folder-btn" onclick="startMode('Endo')">Endo</button>
                    <button class="folder-btn" onclick="startMode('GI')">GI</button>
                    <button class="folder-btn" onclick="startMode('GU_prostate')">GU_prostate</button>
                    <button class="folder-btn" onclick="startMode('GU_RCC')">GU_RCC</button>
                    <button class="folder-btn" onclick="startMode('GU_UCC')">GU_UCC</button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen hidden">
            <div class="header">
                <button class="back-btn" onclick="showFolderSelection()">←</button>
                <h1 id="quizTitle">Quiz Mode</h1>
                <div id="previousAnswer" class="previous-answer hidden"></div>
            </div>
            <div class="quiz-screen">
                <div class="image-container">
                    <img id="quizImage" class="quiz-image" src="" alt="Quiz Image">
                    <div class="image-info">
                        <div class="image-name" id="imageName"></div>
                    </div>
                </div>
                <div id="answerButtons" class="answer-buttons">
                    <button class="answer-btn o" onclick="markAnswer('O')">O</button>
                    <button class="answer-btn x" onclick="markAnswer('X')">X</button>
                </div>
                <div class="control-buttons">
                    <button class="control-btn" onclick="previousImage()">이전</button>
                    <button class="control-btn" onclick="nextImage()">다음</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLOUDINARY_CLOUD_NAME = 'db5wqzdth';
        const FOLDERS = ['BO_SO', 'Breast', 'Endo', 'GI', 'GU_prostate', 'GU_RCC', 'GU_UCC'];
        
        let currentMode = '';
        let selectedFolder = '';
        let currentImageList = [];
        let currentImageIndex = 0;
        let imageHistory = [];
        let answers = JSON.parse(localStorage.getItem('pathologyAnswers') || '{}');
        let imageStats = JSON.parse(localStorage.getItem('imageStats') || '{}');

        // 이미지 URL 생성 함수
        function getImageUrl(imageName) {
            return `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/${imageName}.jpg`;
        }
        
        // 이미지 존재 여부 확인 함수
        async function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // 자동으로 이미지 목록 생성 (패턴 기반으로 존재하는 이미지 찾기)
        async function autoDiscoverImages(folderName) {
            const images = [];
            const maxImages = 20; // 한 번에 체크할 최대 이미지 수
            let foundCount = 0;
            
            // 일반적인 suffix 패턴들
            const commonSuffixes = [
                'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't',
                'wiaute', 'vck5wg', 'u6htti', 'kq4iy8', 'lxlxaf', 'xpils9', 'btqi9d', 'i6rfwf', 'unbktw', 'db80cr',
                'khqouy', 'grezaz', 'rgl0to', 'y5hkcs', 'zf3u6k', 'czd3pw', 'lvfjtd', 'cd12xq', 'mfakk4', 'sizcjt',
                'b4wrpa', 'p0zhzz', 'wsfwf2', 'iirlza', 'j6djon', 'psnyst', 'test', 'img', 'pic', 'sample'
            ];
            
            console.log(`🔍 ${folderName} 폴더에서 이미지 검색 중...`);
            
            // 1_1부터 1_99까지, 2_1부터 2_99까지 체크
            for (let prefix = 1; prefix <= 3 && foundCount < maxImages; prefix++) {
                for (let num = 1; num <= 99 && foundCount < maxImages; num++) {
                    // 몇 개의 일반적인 suffix만 빠르게 체크
                    const testSuffixes = commonSuffixes.slice(0, 5);
                    
                    for (let suffix of testSuffixes) {
                        const imageName = `${folderName}_${prefix}_${num}_${suffix}`;
                        const imageUrl = getImageUrl(imageName);
                        
                        // 비동기로 이미지 존재 확인
                        const exists = await checkImageExists(imageUrl);
                        if (exists) {
                            images.push({
                                name: imageName,
                                url: imageUrl,
                                folder: folderName
                            });
                            foundCount++;
                            console.log(`✅ 발견: ${imageName}`);
                            break; // 해당 번호에서 이미지를 찾으면 다음 번호로
                        }
                    }
                }
            }
            
            console.log(`📊 ${folderName}: ${images.length}개 이미지 발견`);
            return images;
        }

        // 이미지 존재 확인 및 랜덤 이미지 생성
        async function generateImageList(folder = 'all') {
            let imageList = [];
            
            if (folder === 'all') {
                // 모든 폴더에서 이미지 수집
                for (let folderName of FOLDERS) {
                    const folderImages = await getImagesFromFolder(folderName);
                    imageList = imageList.concat(folderImages);
                }
            } else {
                imageList = await getImagesFromFolder(folder);
            }
            
            return shuffleArray(imageList);
        }

        // 특정 폴더에서 이미지 수집
        async function getImagesFromFolder(folderName) {
            // 캐시에서 먼저 확인
            const cacheKey = `images_${folderName}`;
            const cached = localStorage.getItem(cacheKey);
            const cacheTime = localStorage.getItem(`${cacheKey}_time`);
            
            // 캐시가 있고 1시간 이내라면 캐시 사용
            if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
                console.log(`📱 ${folderName} 캐시에서 로드`);
                return JSON.parse(cached);
            }
            
            // 자동 탐지로 이미지 목록 생성
            const images = await autoDiscoverImages(folderName);
            
            // 캐시에 저장
            localStorage.setItem(cacheKey, JSON.stringify(images));
            localStorage.setItem(`${cacheKey}_time`, Date.now().toString());
            
            return images;
        }

        // 배열 셞플
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // 필터된 이미지 리스트 생성 (O 또는 X 마크된 것들)
        function getFilteredImages(answerType) {
            let filtered = [];
            for (let imageName in answers) {
                if (answers[imageName] === answerType) {
                    // 폴더명 추출
                    let folder = '';
                    for (let folderName of FOLDERS) {
                        if (imageName.startsWith(folderName)) {
                            folder = folderName;
                            break;
                        }
                    }
                    
                    filtered.push({
                        name: imageName,
                        url: getImageUrl(imageName),
                        folder: folder
                    });
                }
            }
            return shuffleArray(filtered);
        }

        // 화면 전환
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMainMenu() {
            updateStats();
            showScreen('mainMenu');
        }

        function showFolderSelection(mode) {
            currentMode = mode;
            showScreen('folderSelection');
        }

        // 모드 시작
        async function startMode(folder) {
            selectedFolder = folder;
            
            // 로딩 표시
            document.getElementById('quizTitle').textContent = '이미지 로딩 중...';
            showScreen('quizScreen');
            
            if (currentMode === 'quiz') {
                currentImageList = await generateImageList(folder);
                document.getElementById('quizTitle').textContent = 
                    folder === 'all' ? 'Quiz - All Folders' : `Quiz - ${folder}`;
                document.getElementById('answerButtons').style.display = 'flex';
            } else if (currentMode === 'o') {
                currentImageList = getFilteredImages('O');
                document.getElementById('quizTitle').textContent = 'O Collection';
                document.getElementById('answerButtons').style.display = 'flex';
            } else if (currentMode === 'x') {
                currentImageList = getFilteredImages('X');
                document.getElementById('quizTitle').textContent = 'X Collection';
                document.getElementById('answerButtons').style.display = 'flex';
            }
            
            if (currentImageList.length === 0) {
                alert('해당 조건에 맞는 이미지가 없습니다.');
                showFolderSelection();
                return;
            }
            
            currentImageIndex = 0;
            imageHistory = [0];
            showCurrentImage();
        }

        // 현재 이미지 표시
        function showCurrentImage() {
            if (currentImageList.length === 0) return;
            
            const currentImage = currentImageList[currentImageIndex];
            const img = document.getElementById('quizImage');
            const nameEl = document.getElementById('imageName');
            const previousAnswer = document.getElementById('previousAnswer');
            
            img.src = currentImage.url;
            nameEl.textContent = currentImage.name;
            
            // 이전 답변 표시
            const prevAnswer = answers[currentImage.name];
            if (prevAnswer && currentMode === 'quiz') {
                previousAnswer.textContent = `Previous: ${prevAnswer}`;
                previousAnswer.classList.remove('hidden');
            } else {
                previousAnswer.classList.add('hidden');
            }
            
            // 이미지 로드 에러 처리
            img.onerror = function() {
                console.log('Image failed to load:', currentImage.url);
                // 실제 이미지가 없으면 다음 이미지로 이동
                nextImage();
            };
        }

        // 답변 마킹
        function markAnswer(answer) {
            if (currentImageList.length === 0) return;
            
            const currentImage = currentImageList[currentImageIndex];
            answers[currentImage.name] = answer;
            
            // 통계 업데이트
            if (!imageStats[currentImage.name]) {
                imageStats[currentImage.name] = 0;
            }
            imageStats[currentImage.name]++;
            
            // 로컬 스토리지 저장
            localStorage.setItem('pathologyAnswers', JSON.stringify(answers));
            localStorage.setItem('imageStats', JSON.stringify(imageStats));
            
            // 다음 이미지로 이동
            setTimeout(() => {
                nextImage();
            }, 300);
        }

        // 다음 이미지
        function nextImage() {
            if (currentImageList.length === 0) return;
            
            // 균등한 빈도로 이미지 선택
            currentImageIndex = selectNextImageIndex();
            imageHistory.push(currentImageIndex);
            
            // 히스토리 크기 제한
            if (imageHistory.length > 50) {
                imageHistory = imageHistory.slice(-50);
            }
            
            showCurrentImage();
        }

        // 이전 이미지
        function previousImage() {
            if (imageHistory.length > 1) {
                imageHistory.pop(); // 현재 인덱스 제거
                currentImageIndex = imageHistory[imageHistory.length - 1];
                showCurrentImage();
            }
        }

        // 균등한 빈도로 다음 이미지 선택
        function selectNextImageIndex() {
            // 통계 기반으로 가장 적게 본 이미지들 중에서 선택
            let minViews = Infinity;
            let candidateIndices = [];
            
            for (let i = 0; i < currentImageList.length; i++) {
                const imageName = currentImageList[i].name;
                const views = imageStats[imageName] || 0;
                
                if (views < minViews) {
                    minViews = views;
                    candidateIndices = [i];
                } else if (views === minViews) {
                    candidateIndices.push(i);
                }
            }
            
            // 후보 중에서 랜덤 선택
            return candidateIndices[Math.floor(Math.random() * candidateIndices.length)];
        }

        // 통계 업데이트
        function updateStats() {
            let totalImages = Object.keys(imageStats).length;
            let oCount = 0;
            let xCount = 0;
            
            for (let imageName in answers) {
                if (answers[imageName] === 'O') oCount++;
                if (answers[imageName] === 'X') xCount++;
            }
            
            document.getElementById('totalImages').textContent = totalImages;
            document.getElementById('oCount').textContent = oCount;
            document.getElementById('xCount').textContent = xCount;
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });
    </script>
</body>
</html>
