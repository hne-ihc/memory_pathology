<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Pathology Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 10px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: 80vh;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .previous-answer {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .main-menu {
            padding: 40px 20px;
            text-align: center;
        }
        
        .menu-button {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .quiz-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .quiz-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .o-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .o-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17, 153, 142, 0.3);
        }
        
        .x-button {
            background: linear-gradient(135deg, #ee5a24 0%, #fd79a8 100%);
            color: white;
        }
        
        .x-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(238, 90, 36, 0.3);
        }
        
        .folder-selection {
            padding: 20px;
        }
        
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .folder-btn {
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }
        
        .folder-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .folder-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .quiz-screen {
            padding: 20px;
            text-align: center;
        }
        
        .image-container {
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .quiz-image {
            width: 100%;
            height: auto;
            aspect-ratio: 4/6;
            object-fit: cover;
            display: block;
        }
        
        .image-info {
            background: #f8f9ff;
            padding: 15px;
            border-top: 3px solid #667eea;
        }
        
        .image-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .answer-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
        }
        
        .answer-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .answer-btn.o {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .answer-btn.x {
            background: linear-gradient(135deg, #ee5a24 0%, #fd79a8 100%);
            color: white;
        }
        
        .answer-btn:hover {
            transform: translateY(-2px);
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .control-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .hidden {
            display: none;
        }
        
        .back-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .stats {
            background: #f8f9ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        
        .stat-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Menu -->
        <div id="mainMenu" class="screen">
            <div class="header">
                <h1>Memory Pathology</h1>
            </div>
            <div class="main-menu">
                <button class="menu-button quiz-button" onclick="showFolderSelection('quiz')">QUIZ</button>
                <button class="menu-button o-button" onclick="showFolderSelection('o')">O Collection</button>
                <button class="menu-button x-button" onclick="showFolderSelection('x')">X Collection</button>
                <div class="stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalImages">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="oCount">0</div>
                            <div class="stat-label">O Marked</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="xCount">0</div>
                            <div class="stat-label">X Marked</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Folder Selection -->
        <div id="folderSelection" class="screen hidden">
            <div class="header">
                <button class="back-btn" onclick="showMainMenu()">‚Üê</button>
                <h1>Select Folder</h1>
            </div>
            <div class="folder-selection">
                <button class="menu-button quiz-button" onclick="startMode('all')">ALL FOLDERS</button>
                <div class="folder-grid">
                    <button class="folder-btn" onclick="startMode('BO_SO')">BO_SO</button>
                    <button class="folder-btn" onclick="startMode('Breast')">Breast</button>
                    <button class="folder-btn" onclick="startMode('Endo')">Endo</button>
                    <button class="folder-btn" onclick="startMode('GI')">GI</button>
                    <button class="folder-btn" onclick="startMode('GU_prostate')">GU_prostate</button>
                    <button class="folder-btn" onclick="startMode('GU_RCC')">GU_RCC</button>
                    <button class="folder-btn" onclick="startMode('GU_UCC')">GU_UCC</button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen hidden">
            <div class="header">
                <button class="back-btn" onclick="showFolderSelection()">‚Üê</button>
                <h1 id="quizTitle">Quiz Mode</h1>
                <div id="previousAnswer" class="previous-answer hidden"></div>
            </div>
            <div class="quiz-screen">
                <div class="image-container">
                    <img id="quizImage" class="quiz-image" src="" alt="Quiz Image">
                    <div class="image-info">
                        <div class="image-name" id="imageName"></div>
                    </div>
                </div>
                <div id="answerButtons" class="answer-buttons">
                    <button class="answer-btn o" onclick="markAnswer('O')">O</button>
                    <button class="answer-btn x" onclick="markAnswer('X')">X</button>
                </div>
                <div class="control-buttons">
                    <button class="control-btn" onclick="previousImage()">Ïù¥Ï†Ñ</button>
                    <button class="control-btn" onclick="nextImage()">Îã§Ïùå</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLOUDINARY_CLOUD_NAME = 'db5wqzdth';
        const FOLDERS = ['BO_SO', 'Breast', 'Endo', 'GI', 'GU_prostate', 'GU_RCC', 'GU_UCC'];
        
        let currentMode = '';
        let selectedFolder = '';
        let currentImageList = [];
        let currentImageIndex = 0;
        let imageHistory = [];
        let answers = JSON.parse(localStorage.getItem('pathologyAnswers') || '{}');
        let imageStats = JSON.parse(localStorage.getItem('imageStats') || '{}');

        // Ïù¥ÎØ∏ÏßÄ URL ÏÉùÏÑ± Ìï®Ïàò
        function getImageUrl(imageName) {
            return `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/${imageName}.jpg`;
        }
        
        // Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏ Ìï®Ïàò
        async function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        // ÏûêÎèôÏúºÎ°ú Ïù¥ÎØ∏ÏßÄ Î™©Î°ù ÏÉùÏÑ± (Ìå®ÌÑ¥ Í∏∞Î∞òÏúºÎ°ú Ï°¥Ïû¨ÌïòÎäî Ïù¥ÎØ∏ÏßÄ Ï∞æÍ∏∞)
        async function autoDiscoverImages(folderName) {
            const images = [];
            const maxImages = 20; // Ìïú Î≤àÏóê Ï≤¥ÌÅ¨Ìï† ÏµúÎåÄ Ïù¥ÎØ∏ÏßÄ Ïàò
            let foundCount = 0;
            
            // ÏùºÎ∞òÏ†ÅÏù∏ suffix Ìå®ÌÑ¥Îì§
            const commonSuffixes = [
                'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't',
                'wiaute', 'vck5wg', 'u6htti', 'kq4iy8', 'lxlxaf', 'xpils9', 'btqi9d', 'i6rfwf', 'unbktw', 'db80cr',
                'khqouy', 'grezaz', 'rgl0to', 'y5hkcs', 'zf3u6k', 'czd3pw', 'lvfjtd', 'cd12xq', 'mfakk4', 'sizcjt',
                'b4wrpa', 'p0zhzz', 'wsfwf2', 'iirlza', 'j6djon', 'psnyst', 'test', 'img', 'pic', 'sample'
            ];
            
            console.log(`üîç ${folderName} Ìè¥ÎçîÏóêÏÑú Ïù¥ÎØ∏ÏßÄ Í≤ÄÏÉâ Ï§ë...`);
            
            // 1_1Î∂ÄÌÑ∞ 1_99ÍπåÏßÄ, 2_1Î∂ÄÌÑ∞ 2_99ÍπåÏßÄ Ï≤¥ÌÅ¨
            for (let prefix = 1; prefix <= 3 && foundCount < maxImages; prefix++) {
                for (let num = 1; num <= 99 && foundCount < maxImages; num++) {
                    // Î™á Í∞úÏùò ÏùºÎ∞òÏ†ÅÏù∏ suffixÎßå Îπ†Î•¥Í≤å Ï≤¥ÌÅ¨
                    const testSuffixes = commonSuffixes.slice(0, 5);
                    
                    for (let suffix of testSuffixes) {
                        const imageName = `${folderName}_${prefix}_${num}_${suffix}`;
                        const imageUrl = getImageUrl(imageName);
                        
                        // ÎπÑÎèôÍ∏∞Î°ú Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨ ÌôïÏù∏
                        const exists = await checkImageExists(imageUrl);
                        if (exists) {
                            images.push({
                                name: imageName,
                                url: imageUrl,
                                folder: folderName
                            });
                            foundCount++;
                            console.log(`‚úÖ Î∞úÍ≤¨: ${imageName}`);
                            break; // Ìï¥Îãπ Î≤àÌò∏ÏóêÏÑú Ïù¥ÎØ∏ÏßÄÎ•º Ï∞æÏúºÎ©¥ Îã§Ïùå Î≤àÌò∏Î°ú
                        }
                    }
                }
            }
            
            console.log(`üìä ${folderName}: ${images.length}Í∞ú Ïù¥ÎØ∏ÏßÄ Î∞úÍ≤¨`);
            return images;
        }

        // Ïù¥ÎØ∏ÏßÄ Ï°¥Ïû¨ ÌôïÏù∏ Î∞è ÎûúÎç§ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
        async function generateImageList(folder = 'all') {
            let imageList = [];
            
            if (folder === 'all') {
                // Î™®Îì† Ìè¥ÎçîÏóêÏÑú Ïù¥ÎØ∏ÏßÄ ÏàòÏßë
                for (let folderName of FOLDERS) {
                    const folderImages = await getImagesFromFolder(folderName);
                    imageList = imageList.concat(folderImages);
                }
            } else {
                imageList = await getImagesFromFolder(folder);
            }
            
            return shuffleArray(imageList);
        }

        // ÌäπÏ†ï Ìè¥ÎçîÏóêÏÑú Ïù¥ÎØ∏ÏßÄ ÏàòÏßë
        async function getImagesFromFolder(folderName) {
            // Ï∫êÏãúÏóêÏÑú Î®ºÏ†Ä ÌôïÏù∏
            const cacheKey = `images_${folderName}`;
            const cached = localStorage.getItem(cacheKey);
            const cacheTime = localStorage.getItem(`${cacheKey}_time`);
            
            // Ï∫êÏãúÍ∞Ä ÏûàÍ≥† 1ÏãúÍ∞Ñ Ïù¥ÎÇ¥ÎùºÎ©¥ Ï∫êÏãú ÏÇ¨Ïö©
            if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < 3600000) {
                console.log(`üì± ${folderName} Ï∫êÏãúÏóêÏÑú Î°úÎìú`);
                return JSON.parse(cached);
            }
            
            // ÏûêÎèô ÌÉêÏßÄÎ°ú Ïù¥ÎØ∏ÏßÄ Î™©Î°ù ÏÉùÏÑ±
            const images = await autoDiscoverImages(folderName);
            
            // Ï∫êÏãúÏóê Ï†ÄÏû•
            localStorage.setItem(cacheKey, JSON.stringify(images));
            localStorage.setItem(`${cacheKey}_time`, Date.now().toString());
            
            return images;
        }

        // Î∞∞Ïó¥ ÏÖûÌîå
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ÌïÑÌÑ∞Îêú Ïù¥ÎØ∏ÏßÄ Î¶¨Ïä§Ìä∏ ÏÉùÏÑ± (O ÎòêÎäî X ÎßàÌÅ¨Îêú Í≤ÉÎì§)
        function getFilteredImages(answerType) {
            let filtered = [];
            for (let imageName in answers) {
                if (answers[imageName] === answerType) {
                    // Ìè¥ÎçîÎ™Ö Ï∂îÏ∂ú
                    let folder = '';
                    for (let folderName of FOLDERS) {
                        if (imageName.startsWith(folderName)) {
                            folder = folderName;
                            break;
                        }
                    }
                    
                    filtered.push({
                        name: imageName,
                        url: getImageUrl(imageName),
                        folder: folder
                    });
                }
            }
            return shuffleArray(filtered);
        }

        // ÌôîÎ©¥ Ï†ÑÌôò
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMainMenu() {
            updateStats();
            showScreen('mainMenu');
        }

        function showFolderSelection(mode) {
            currentMode = mode;
            showScreen('folderSelection');
        }

        // Î™®Îìú ÏãúÏûë
        async function startMode(folder) {
            selectedFolder = folder;
            
            // Î°úÎî© ÌëúÏãú
            document.getElementById('quizTitle').textContent = 'Ïù¥ÎØ∏ÏßÄ Î°úÎî© Ï§ë...';
            showScreen('quizScreen');
            
            if (currentMode === 'quiz') {
                currentImageList = await generateImageList(folder);
                document.getElementById('quizTitle').textContent = 
                    folder === 'all' ? 'Quiz - All Folders' : `Quiz - ${folder}`;
                document.getElementById('answerButtons').style.display = 'flex';
            } else if (currentMode === 'o') {
                currentImageList = getFilteredImages('O');
                document.getElementById('quizTitle').textContent = 'O Collection';
                document.getElementById('answerButtons').style.display = 'flex';
            } else if (currentMode === 'x') {
                currentImageList = getFilteredImages('X');
                document.getElementById('quizTitle').textContent = 'X Collection';
                document.getElementById('answerButtons').style.display = 'flex';
            }
            
            if (currentImageList.length === 0) {
                alert('Ìï¥Îãπ Ï°∞Í±¥Ïóê ÎßûÎäî Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                showFolderSelection();
                return;
            }
            
            currentImageIndex = 0;
            imageHistory = [0];
            showCurrentImage();
        }

        // ÌòÑÏû¨ Ïù¥ÎØ∏ÏßÄ ÌëúÏãú
        function showCurrentImage() {
            if (currentImageList.length === 0) return;
            
            const currentImage = currentImageList[currentImageIndex];
            const img = document.getElementById('quizImage');
            const nameEl = document.getElementById('imageName');
            const previousAnswer = document.getElementById('previousAnswer');
            
            img.src = currentImage.url;
            nameEl.textContent = currentImage.name;
            
            // Ïù¥Ï†Ñ ÎãµÎ≥Ä ÌëúÏãú
            const prevAnswer = answers[currentImage.name];
            if (prevAnswer && currentMode === 'quiz') {
                previousAnswer.textContent = `Previous: ${prevAnswer}`;
                previousAnswer.classList.remove('hidden');
            } else {
                previousAnswer.classList.add('hidden');
            }
            
            // Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏóêÎü¨ Ï≤òÎ¶¨
            img.onerror = function() {
                console.log('Image failed to load:', currentImage.url);
                // Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Îã§Ïùå Ïù¥ÎØ∏ÏßÄÎ°ú Ïù¥Îèô
                nextImage();
            };
        }

        // ÎãµÎ≥Ä ÎßàÌÇπ
        function markAnswer(answer) {
            if (currentImageList.length === 0) return;
            
            const currentImage = currentImageList[currentImageIndex];
            answers[currentImage.name] = answer;
            
            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            if (!imageStats[currentImage.name]) {
                imageStats[currentImage.name] = 0;
            }
            imageStats[currentImage.name]++;
            
            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû•
            localStorage.setItem('pathologyAnswers', JSON.stringify(answers));
            localStorage.setItem('imageStats', JSON.stringify(imageStats));
            
            // Îã§Ïùå Ïù¥ÎØ∏ÏßÄÎ°ú Ïù¥Îèô
            setTimeout(() => {
                nextImage();
            }, 300);
        }

        // Îã§Ïùå Ïù¥ÎØ∏ÏßÄ
        function nextImage() {
            if (currentImageList.length === 0) return;
            
            // Í∑†Îì±Ìïú ÎπàÎèÑÎ°ú Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù
            currentImageIndex = selectNextImageIndex();
            imageHistory.push(currentImageIndex);
            
            // ÌûàÏä§ÌÜ†Î¶¨ ÌÅ¨Í∏∞ Ï†úÌïú
            if (imageHistory.length > 50) {
                imageHistory = imageHistory.slice(-50);
            }
            
            showCurrentImage();
        }

        // Ïù¥Ï†Ñ Ïù¥ÎØ∏ÏßÄ
        function previousImage() {
            if (imageHistory.length > 1) {
                imageHistory.pop(); // ÌòÑÏû¨ Ïù∏Îç±Ïä§ Ï†úÍ±∞
                currentImageIndex = imageHistory[imageHistory.length - 1];
                showCurrentImage();
            }
        }

        // Í∑†Îì±Ìïú ÎπàÎèÑÎ°ú Îã§Ïùå Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù
        function selectNextImageIndex() {
            // ÌÜµÍ≥Ñ Í∏∞Î∞òÏúºÎ°ú Í∞ÄÏû• Ï†ÅÍ≤å Î≥∏ Ïù¥ÎØ∏ÏßÄÎì§ Ï§ëÏóêÏÑú ÏÑ†ÌÉù
            let minViews = Infinity;
            let candidateIndices = [];
            
            for (let i = 0; i < currentImageList.length; i++) {
                const imageName = currentImageList[i].name;
                const views = imageStats[imageName] || 0;
                
                if (views < minViews) {
                    minViews = views;
                    candidateIndices = [i];
                } else if (views === minViews) {
                    candidateIndices.push(i);
                }
            }
            
            // ÌõÑÎ≥¥ Ï§ëÏóêÏÑú ÎûúÎç§ ÏÑ†ÌÉù
            return candidateIndices[Math.floor(Math.random() * candidateIndices.length)];
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            let totalImages = Object.keys(imageStats).length;
            let oCount = 0;
            let xCount = 0;
            
            for (let imageName in answers) {
                if (answers[imageName] === 'O') oCount++;
                if (answers[imageName] === 'X') xCount++;
            }
            
            document.getElementById('totalImages').textContent = totalImages;
            document.getElementById('oCount').textContent = oCount;
            document.getElementById('xCount').textContent = xCount;
        }

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });
    </script>
</body>
</html>
